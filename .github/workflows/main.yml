name: Build

on:
  push:
    branches:
      - develop
      - release

  pull_request:
    branches:
      - '*'

env:
  SOURCE_DIR: ${{ github.workspace }}
  BUILD_DIR: ${{ github.workspace }}/build
  INSTALL_DIR: ${{ github.workspace }}/roadrunner-"$RUNNER_OS"
  LLVM_INSTALL_PREFIX: ${{ github.workspace }}/llvm
  DEPS_INSTALL_PREFIX: ${{ github.workspace }}/libroadrunner-deps
  SWIG_SOURCE_DIR: ${{ github.workspace }}/swig
  SWIG_INSTALL_PREFIX: ${{ github.workspace }}/swig/install-azure
  SWIG_EXECUTABLE: ${{ github.workspace }}/swig/install-azure/bin/swig



jobs:
  WindowsBuildRoadrunnerCpp:
    runs-on: windows-latest

    env:
      LLVM_CACHE: 'false'
      MinicondaRoot: 'C:\Miniconda'
      PythonName: 'py39'
      PythonVersion: '3.9'
      PythonRoot: 'C:\Miniconda\envs\py39'
      PythonLibDir: 'C:\Miniconda\envs\py39\Lib'
      PythonScriptsDir: 'C:\Miniconda\envs\py39\Scripts'
      PythonExecutable: 'C:\Miniconda\envs\py39\python.exe'
      PipExecutable: 'C:\Miniconda\envs\py39\Scripts\pip.exe'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Print Environment Variables
        shell: pwsh
        run: |
          echo "LLVM_CACHE=${env:LLVM_CACHE}"
          echo "PythonName=${env:PythonName}"
          echo "LLVM_CONFIG_EXECUTABLE=${env:LLVM_INSTALL_PREFIX}\bin\llvm-config"
          echo "MinicondaRoot=${env:MinicondaRoot}"
          echo "PythonRoot=${env:PythonRoot}"
          echo "PythonLibDir=${env:PythonLibDir}"
          echo "PythonExecutable=${env:PythonExecutable}"
          echo "CondaExecutable=${env:MinicondaRoot}\condabin\conda"
          echo "PipExecutable=${env:PipExecutable}"

      - name: Make Directories
        shell: pwsh
        run: |
          mkdir ${env:LLVM_INSTALL_PREFIX}
          mkdir ${env:DEPS_INSTALL_PREFIX}

      - name: Setup conda
        uses: s-weigand/setup-conda@v1
        with:
          update-conda: true
          python-version: 3.9

      - name: Add conda to PATH
        shell: pwsh
        run: |
          Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"

      - name: Print Python Variables
        shell: pwsh
        run: |
          where.exe conda
          where.exe python
          echo "PythonVersion ${env:PythonVersion}"
          echo "PythonName ${env:PythonName}"
          echo "MinicondaRoot ${env:MinicondaRoot}"
          echo "PythonRoot ${env:PythonRoot}"
          echo "PythonLibDir ${env:PythonLibDir}"
            
      - name: Install packages using conda
        shell: pwsh
        run: |
          Write-Host "Creating new conda environment"
          conda create --quiet --yes --name ${env:PythonName} python=${env:PythonVersion}
          Write-Host "pip upgrade:"
          C:\Miniconda\envs\py39\Scripts\pip.exe install --upgrade pip
          Write-Host "pip help:"
          C:\Miniconda\envs\py39\Scripts\pip.exe install --help
          Write-Host "${env:PipExecutable} install requests"
          C:\Miniconda\envs\py39\Scripts\pip.exe install requests
          Write-Host "${env:PipExecutable} install numpy"
          C:\Miniconda\envs\py39\Scripts\pip.exe install numpy